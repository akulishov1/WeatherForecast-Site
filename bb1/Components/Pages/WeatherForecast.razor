@page "/"
@rendermode InteractiveServer
@inject WeatherRecordsService WeatherRecordsService
@inject WeatherDataRequestService WeatherDataRequestService
@inject WeatherRepositoryService WeatherRepositoryService
@inject WeatherDataRequestService.IWeatherService WeatherService
@inject WeatherDataRequestService.IWeatherService _weatherService
@using Models
@using bb1.Services

<style>
    body {
    background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/42/Blue_sky%2C_white-gray_clouds.JPG');
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-color: lightblue;
    }
</style>
<div style="position: fixed; top: 100px; left: 450px; z-index: 1000;">
    <select @onchange="OnSiteChanged" class="form-select" style="width: auto; min-width: 150px;">

        @foreach (var site in SiteDataSelectionList.SiteSelection)
        {

            <option value="@site.id" selected="@((site.id == SelectedSiteID) ? "selected" : null)">

                @site.name

            </option>

        }

    </select>
</div>

<DxGridLayout CssClass="main-container" ColumnSpacing="8px" RowSpacing="60px"
style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
    <Rows>
        <DxGridLayoutRow Areas="mainContent" />
        <DxGridLayoutRow Areas="controls" />
    </Rows>
    <Items>
        <DxGridLayoutItem Area="mainContent">
            <Template>
                <div class="main-content"
                style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    @if (DataList.ContainsKey(DayNumber) && DataList[DayNumber].Any())
                    {
                        var weatherRecord = DataList[DayNumber].First();

                        <DxGridLayout CssClass="h-60" ColumnSpacing="8px" RowSpacing="60px"
                        style="background-color: rgba(155, 221, 255, 0.7); width: 720px; height: 700px; border-radius: 40px;">
                            <Rows>
                                <DxGridLayoutRow Areas="Time" />
                                <DxGridLayoutRow Areas="NameOfTheChosenDay" />
                                <DxGridLayoutRow Areas="Temperature" />
                                <DxGridLayoutRow Areas="Windspeed" />
                                <DxGridLayoutRow Areas="MinMaxTemperature" />
                            </Rows>
                            <Items>
                                <DxGridLayoutItem Area="Time">
                                    <Template>
                                        <div style="text-align: center; font-size: 50px;margin-bottom: 30px;">
                                            Time now: @CurrentTime.ToString(@"hh\:mm\:ss")
                                        </div>
                                    </Template>
                                </DxGridLayoutItem>
                                <DxGridLayoutItem Area="NameOfTheChosenDay">
                                    <Template>
                                        <div style="text-align: center; font-size: 50px;">
                                            Current Day is: @SelectedDayName
                                        </div>
                                    </Template>
                                </DxGridLayoutItem>
                                <DxGridLayoutItem Area="Temperature">
                                    <Template>
                                        <div style="text-align: center; font-size: 30px;">
                                            Average Temperature is: @weatherRecord.AvgTemperature °C <p style="margin-top: 10px;">Minimal Temperature is: @weatherRecord.MinTemperature °C</p> <p style="margin-top: 10px;">Maximum Temperature is: @weatherRecord.MaxTemperature °C</p>
                                        </div>
                                    </Template>
                                </DxGridLayoutItem>
                                <DxGridLayoutItem Area="Windspeed">
                                    <Template>
                                        <div style="text-align: center; font-size: 30px;">
                                            Average Wind speed: @weatherRecord.AvgWindSpeed m/s
                                        </div>
                                    </Template>
                                </DxGridLayoutItem>
                                <DxGridLayoutItem Area="MinMaxTemperature">
                                    <Template>
                                        <!-- Flex container with horizontal items -->
                                        <div style="display: flex; gap: 10px; width: 100%; justify-content: center;">
                                            <div style="flex: 1; background-color: #FFEFEB; padding: 10px; border-radius: 10px; text-align: center; font-size: 20px; color: black;">
                                                Morning: @weatherRecord.TemperatureMorn °C
                                            </div>
                                            <div style="flex: 1; background-color: #EBFCEF; padding: 10px; border-radius: 10px; text-align: center; font-size: 20px;color: black;">
                                                Day: @weatherRecord.TemperatureDay °C
                                            </div>
                                            <div style="flex: 1; background-color: #F0EBFF; padding: 10px; border-radius: 10px; text-align: center; font-size: 20px;color: black;">
                                                Evening: @weatherRecord.TemperatureEve °C
                                            </div>
                                            <div style="flex: 1; background-color: #EBF0FF; padding: 10px; border-radius: 10px; text-align: center; font-size: 20px;color: black;">
                                                Night: @weatherRecord.TemperatureNight °C
                                            </div>
                                        </div>
                                    </Template>
                                </DxGridLayoutItem>
                            </Items>
                        </DxGridLayout>
                    }
                    else
                    {
                        <div style="text-align: center; font-size: 40px;">
                            No Data Available for Selected Day
                        </div>
                    }
                </div>
            </Template>
        </DxGridLayoutItem>

        <DxGridLayoutItem Area="controls">
            <Template>
                <div style="display: flex; justify-content: center; align-items: center;">
                    <DxGridLayout CssClass="h-60" ColumnSpacing="8px" RowSpacing="10px"
                    style="background-color: rgba(155, 221, 255, 0.7); width: 800px; height: 150px; border-radius: 40px;">
                        <Rows>
                            <DxGridLayoutRow Areas="Buttons" />
                        </Rows>
                        <Items>
                            <DxGridLayoutItem Area="Buttons">
                                <Template>

                                    <div class="gridlayout-header gridlayout-item" style="display: flex; justify-content: center; align-items: center; gap: 20px;">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            int currentDay = i; // capture current value
                                            <DxButton Click="@(async () => await Day(currentDay))"
                                            style="width:150px; height:150px; border-radius:10px; background-color:burlywood; border-color:aqua">
                                                <div style="display: flex; flex-direction: column; align-items: center;">
                                                    <span style="font-size: 16px;">
                                                        @(DataList.ContainsKey(currentDay) && DataList[currentDay].Any()
                                                                            ? DataList[currentDay].First().CellDate.ToString("dddd")
                                                                            : $"Weather Data for {currentDay}")
                                                    </span>
                                                    <span style="font-size: 16px; margin-top: 5px;">
                                                        @(DataList.ContainsKey(currentDay) && DataList[currentDay].Any()
                                                                            ? string.Join(", ", DataList[currentDay].Select(day => $"{day.AvgTemperature}°C - {day.AvgWindSpeed} m/s"))
                                                                            : "No Data")
                                                    </span>
                                                </div>
                                            </DxButton>
                                        }
                                    </div>
                                </Template>
                            </DxGridLayoutItem>
                        </Items>
                    </DxGridLayout>
                </div>
            </Template>
        </DxGridLayoutItem>
    </Items>
</DxGridLayout>

@code {
    private TimeSpan CurrentTime;
    private int DayNumber = 1;
    private int SelectedSiteID = 1;
    private int PreviousSiteID = 1;
    private CancellationTokenSource _cts = new();
    private string SelectedDayName =>
    DataList.ContainsKey(DayNumber) && DataList[DayNumber].Any()
        ? DataList[DayNumber].First().CellDate.ToString("dddd")
        : "Unknown";

    // Holds WeatherRecord objects fetched for each day.
    private Dictionary<int, List<WeatherRecordBase>> DataList = new Dictionary<int, List<WeatherRecordBase>>();

    protected override async Task OnInitializedAsync()
    {
        CurrentTime = WeatherRecordsService.GetServerTime();

        _ = Task.Run(async () =>
       {
           while (!_cts.Token.IsCancellationRequested)
           {
               CurrentTime = WeatherRecordsService.GetServerTime();
               await InvokeAsync(StateHasChanged);
               await Task.Delay(1000, _cts.Token);
           }
       });

        var isUpToDate = await WeatherRepositoryService.IsWeatherDataUpToDateAsync(SelectedSiteID);
        var isTableEmpty = await WeatherRepositoryService.IsTableEmptyAsync(SelectedSiteID);

        if (!isUpToDate || isTableEmpty)
        {
            var weatherData = await _weatherService.FetchWeatherDataAsync(SelectedSiteID);
            await WeatherRepositoryService.SaveWeatherDataAsync(SelectedSiteID, weatherData);
        }

        for (int day = 1; day <= 5; day++)
        {
            var record = await WeatherRecordsService.GetRecordByIdAndSiteIDAsync(SelectedSiteID, day);
            DataList[day] = record is not null ? new List<WeatherRecordBase> { record } : new List<WeatherRecordBase>();
        }

    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }

    private async Task OnSiteChanged(ChangeEventArgs e)
    {
        int newSiteID = int.Parse(e.Value?.ToString() ?? "1");

        if (newSiteID != PreviousSiteID)
        {
            SelectedSiteID = newSiteID;

            var weatherData = await _weatherService.FetchWeatherDataAsync(SelectedSiteID);
            await WeatherRepositoryService.SaveWeatherDataAsync(SelectedSiteID, weatherData);

            for (int day = 1; day <= 5; day++)
            {
                var record = await WeatherRecordsService.GetRecordByIdAndSiteIDAsync(SelectedSiteID, day);
                DataList[day] = record is not null ? new List<WeatherRecordBase> { record } : new List<WeatherRecordBase>();
            }

            PreviousSiteID = SelectedSiteID;

            StateHasChanged();
        }
    }

    // This method gets called when a day button is clicked.
    private async Task Day(int selectedDayNumber)
    {
        DayNumber = selectedDayNumber;

        var record = await WeatherRecordsService.GetRecordByIdAndSiteIDAsync(SelectedSiteID, DayNumber);
        DataList[DayNumber] = record is not null ? new List<WeatherRecordBase> { record } : new List<WeatherRecordBase>();

        // Call StateHasChanged using InvokeAsync for thread safety.
        await InvokeAsync(StateHasChanged);
    }

    [SupplyParameterFromQuery(Name = UrlGenerator.ToggleSidebarName)]
    public bool ToggledSidebar { get; set; }
}